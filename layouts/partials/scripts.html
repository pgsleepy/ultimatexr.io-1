<!-- Retrieve modules from site params -->
{{- $modules := .Site.Params.jsmodules -}}

<!-- Initialize an empty dictionary for imports -->
{{- $imports := dict -}}

<!-- Process each module -->
{{- range $key, $value := $modules -}}
  {{- $path := "" -}}
  {{- if or (hasPrefix $value "http://") (hasPrefix $value "https://") -}}
    {{- $path = $value -}}
  {{- else -}}
    {{- $resource := resources.Get $value | fingerprint -}}
    {{- $path = $resource.RelPermalink -}}
  {{- end -}}
  {{- $imports = merge $imports (dict $key $path) -}}
{{- end -}}

<!-- Import Map -->
<script type="importmap" data-turbo-track="reload">
{
  "imports": {{ $imports | jsonify (dict "indent" "  ") }}
}
</script>

<!-- Module Preloads -->
{{- range $key, $path := $imports -}}
<link rel="modulepreload" href="{{ $path }}">
{{ end }}

<!-- Initialize the main JavaScript module -->
<script type="module">
  import "application"
</script>

<script src="https://cdn.jsdelivr.net/npm/video.js@7.19.2/dist/video.min.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.js?id={{- .Site.Params.google_tag_id -}}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{- .Site.Params.google_tag_id -}}');
</script>
